/*
 * lws-minimal-secure-streams
 *
 * Written in 2010-2020 by Andy Green <andy@warmcat.com>
 *
 * This file is made available under the Creative Commons CC0 1.0
 * Universal Public Domain Dedication.
 *
 *
 * This demonstrates a minimal http client using secure streams api.
 *
 * It visits https://warmcat.com/ and receives the html page there.
 *
 * This is the "secure streams" api equivalent of minimal-http-client.
 *
 * See lws-minimal-secure-streams-seq for the same thing with a sequencer
 * integrated in above the secure stream.
 *
 * The layering looks like this
 *
 *                        lifetime
 *
 * ------   app   ------  process
 * --- secure stream ---  process
 * -------  wsi  -------  connection
 *
 * Use the -f switch to select a secure stream with a policy that misdirects
 * it to connect to the wrong port on the server, for testing the retry
 * handling.
 */
#include <libwebsockets.h>
#include <string.h>
#include <signal.h>

static FILE *file_ptr;
static int interrupted, bad = 1, is_proxy, just_once;
/*
 * We just define enough policy so it can fetch the latest one securely...
 * You can point it to any webserver, this uses
 *
 * https://warmcat.com/policy/minimal-proxy.json
 *
 * ... you can also visit it in a browser to see the JSON policy
 */

static const char * const default_ss_policy =
	"{"
	  "\"release\":"			"\"01234567\","
	  "\"product\":"			"\"myproduct\","
	  "\"schema-version\":"			"1,"
	  "\"retry\": ["	/* named backoff / retry strategies */
		"{\"default\": {"
			"\"backoff\": ["	 "1000,"
						 "2000,"
						 "3000,"
						 "5000,"
						"10000"
				"],"
			"\"conceal\":"		"5,"
			"\"jitterpc\":"		"20,"
			"\"svalidping\":"	"30,"
			"\"svalidhup\":"	"35"
		"}}"
	  "],"
	  "\"certs\": [" /* named individual certificates in BASE64 DER */
		/*
		 * Let's Encrypt certs for warmcat.com / libwebsockets.org
		 *
		 * We fetch the real policy from there using SS and switch to
		 * using that.
		 */
		"{\"isrg_root_x1\": \"" /* ISRG ROOT X1 */
	"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw"
	"TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh"
	"cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4"
	"WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu"
	"ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY"
	"MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc"
	"h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+"
	"0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U"
	"A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW"
	"T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH"
	"B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC"
	"B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv"
	"KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn"
	"OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn"
	"jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw"
	"qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI"
	"rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV"
	"HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq"
	"hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL"
	"ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ"
	"3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK"
	"NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5"
	"ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur"
	"TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC"
	"jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc"
	"oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq"
	"4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA"
	"mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d"
	"emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc="
		"\"},"
		"{\"LEX3_isrg_root_x1\": \"" /* LE X3 signed by ISRG X1 root */
	"MIIFjTCCA3WgAwIBAgIRANOxciY0IzLc9AUoUSrsnGowDQYJKoZIhvcNAQELBQAw"
	"TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh"
	"cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTYxMDA2MTU0MzU1"
	"WhcNMjExMDA2MTU0MzU1WjBKMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3Mg"
	"RW5jcnlwdDEjMCEGA1UEAxMaTGV0J3MgRW5jcnlwdCBBdXRob3JpdHkgWDMwggEi"
	"MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCc0wzwWuUuR7dyXTeDs2hjMOrX"
	"NSYZJeG9vjXxcJIvt7hLQQWrqZ41CFjssSrEaIcLo+N15Obzp2JxunmBYB/XkZqf"
	"89B4Z3HIaQ6Vkc/+5pnpYDxIzH7KTXcSJJ1HG1rrueweNwAcnKx7pwXqzkrrvUHl"
	"Npi5y/1tPJZo3yMqQpAMhnRnyH+lmrhSYRQTP2XpgofL2/oOVvaGifOFP5eGr7Dc"
	"Gu9rDZUWfcQroGWymQQ2dYBrrErzG5BJeC+ilk8qICUpBMZ0wNAxzY8xOJUWuqgz"
	"uEPxsR/DMH+ieTETPS02+OP88jNquTkxxa/EjQ0dZBYzqvqEKbbUC8DYfcOTAgMB"
	"AAGjggFnMIIBYzAOBgNVHQ8BAf8EBAMCAYYwEgYDVR0TAQH/BAgwBgEB/wIBADBU"
	"BgNVHSAETTBLMAgGBmeBDAECATA/BgsrBgEEAYLfEwEBATAwMC4GCCsGAQUFBwIB"
	"FiJodHRwOi8vY3BzLnJvb3QteDEubGV0c2VuY3J5cHQub3JnMB0GA1UdDgQWBBSo"
	"SmpjBH3duubRObemRWXv86jsoTAzBgNVHR8ELDAqMCigJqAkhiJodHRwOi8vY3Js"
	"LnJvb3QteDEubGV0c2VuY3J5cHQub3JnMHIGCCsGAQUFBwEBBGYwZDAwBggrBgEF"
	"BQcwAYYkaHR0cDovL29jc3Aucm9vdC14MS5sZXRzZW5jcnlwdC5vcmcvMDAGCCsG"
	"AQUFBzAChiRodHRwOi8vY2VydC5yb290LXgxLmxldHNlbmNyeXB0Lm9yZy8wHwYD"
	"VR0jBBgwFoAUebRZ5nu25eQBc4AIiMgaWPbpm24wDQYJKoZIhvcNAQELBQADggIB"
	"ABnPdSA0LTqmRf/Q1eaM2jLonG4bQdEnqOJQ8nCqxOeTRrToEKtwT++36gTSlBGx"
	"A/5dut82jJQ2jxN8RI8L9QFXrWi4xXnA2EqA10yjHiR6H9cj6MFiOnb5In1eWsRM"
	"UM2v3e9tNsCAgBukPHAg1lQh07rvFKm/Bz9BCjaxorALINUfZ9DD64j2igLIxle2"
	"DPxW8dI/F2loHMjXZjqG8RkqZUdoxtID5+90FgsGIfkMpqgRS05f4zPbCEHqCXl1"
	"eO5HyELTgcVlLXXQDgAWnRzut1hFJeczY1tjQQno6f6s+nMydLN26WuU4s3UYvOu"
	"OsUxRlJu7TSRHqDC3lSE5XggVkzdaPkuKGQbGpny+01/47hfXXNB7HntWNZ6N2Vw"
	"p7G6OfY+YQrZwIaQmhrIqJZuigsrbe3W+gdn5ykE9+Ky0VgVUsfxo52mwFYs1JKY"
	"2PGDuWx8M6DlS6qQkvHaRUo0FMd8TsSlbF0/v965qGFKhSDeQoMpYnwcmQilRh/0"
	"ayLThlHLN81gSkJjVrPI0Y8xCVPB4twb1PFUd2fPM3sA1tJ83sZ5v8vgFv2yofKR"
	"PB0t6JzUA81mSqM3kxl5e+IZwhYAyO0OTg3/fs8HqGTNKd9BqoUwSRBzp06JMg5b"
	"rUCGwbCUDI0mxadJ3Bz4WxR6fyNpBK2yAinWEsikxqEt"
		"\"}"
	  "],"
	  "\"trust_stores\": [" /* named cert chains */
		"{"
			"\"name\": \"le_via_isrg\","
			"\"stack\": ["
				"\"isrg_root_x1\","
				"\"LEX3_isrg_root_x1\""
			"]"
		"}"
	  "],"
	  "\"s\": ["
		"{\"fetch_policy\": {"
			"\"endpoint\":"		"\"warmcat.com\","
			"\"port\":"		"443,"
			"\"protocol\":"		"\"h1\","
			"\"http_method\":"	"\"GET\","
			"\"http_url\":"		"\"policy/minimal-proxy.json\","
			"\"tls\":"		"true,"
			"\"opportunistic\":"	"true,"
			"\"retry\":"		"\"default\","
			"\"tls_trust_store\":"	"\"le_via_isrg\""
		"}}"
	"}"
;

static const char *canned_root_token_payload =
	"grant_type=refresh_token"
	"&refresh_token=Atzr|IwEBIJedGXjDqsU_vMxykqOMg"
	"SHfYe3CPcedueWEMWSDMaDnEmiW8RlR1Kns7Cb4B-TOSnqp7ifVsY4BMY2B8tpHfO39XP"
	"zfu9HapGjTR458IyHX44FE71pWJkGZ79uVBpljP4sazJuk8XS3Oe_yLnm_DIO6fU1nU3Y"
	"0flYmsOiOAQE_gRk_pdlmEtHnpMA-9rLw3mkY5L89Ty9kUygBsiFaYatouROhbsTn8-jW"
	"k1zZLUDpT6ICtBXSnrCIg0pUbZevPFhTwdXd6eX-u4rq0W-XaDvPWFO7au-iPb4Zk5eZE"
	"iX6sissYrtNmuEXc2uHu7MnQO1hHCaTdIO2CANVumf-PHSD8xseamyh04sLV5JgFzY45S"
	"KvKMajiUZuLkMokOx86rjC2Hdkx5DO7G-dbG1ufBDG-N79pFMSs7Ck5pc283IdLoJkCQc"
	"AGvTX8o8I29QqkcGou-9TKhOJmpX8As94T61ok0UqqEKPJ7RhfQHHYdCtsdwxgvfVr9qI"
	"xL_hDCcTho8opCVX-6QhJHl6SQFlTw13"
	"&client_id="
		"amzn1.application-oa2-client.4823334c434b4190a2b5a42c07938a2d";

/*
 * This asn.1 DER was produced by
 *
 * $ cat 707f15c7fd-certificate.pem.crt | tail -n+2 | head -n-1 | base64 -d \
 *    hexdump -C | tr -s ' ' | sed "s/|.*\$//g" | cut -d' ' -f2-17 | \
 *    grep -v 000 | sed "s/\ /,\ 0x/g" | sed "s/^/0x/g" | sed "s/,\ 0x\$//g" | \
 *    sed "s/\$/,/g" | fold -s -w48
 *
 * It's 25% smaller than the PEM
 */

static const uint8_t client_cert_707f15c7fd_der[] = {
	0x30, 0x82, 0x03, 0x5a, 0x30, 0x82, 0x02, 0x42,
	0xa0, 0x03, 0x02, 0x01, 0x02, 0x02, 0x15, 0x00,
	0xeb, 0x74, 0xf6, 0xd4, 0xad, 0xd9, 0x8e, 0xea,
	0x4c, 0xf3, 0x9f, 0xf0, 0xc6, 0xba, 0xa1, 0x58,
	0xf2, 0xc8, 0x4d, 0x7b, 0x30, 0x0d, 0x06, 0x09,
	0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
	0x0b, 0x05, 0x00, 0x30, 0x4d, 0x31, 0x4b, 0x30,
	0x49, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x42,
	0x41, 0x6d, 0x61, 0x7a, 0x6f, 0x6e, 0x20, 0x57,
	0x65, 0x62, 0x20, 0x53, 0x65, 0x72, 0x76, 0x69,
	0x63, 0x65, 0x73, 0x20, 0x4f, 0x3d, 0x41, 0x6d,
	0x61, 0x7a, 0x6f, 0x6e, 0x2e, 0x63, 0x6f, 0x6d,
	0x20, 0x49, 0x6e, 0x63, 0x2e, 0x20, 0x4c, 0x3d,
	0x53, 0x65, 0x61, 0x74, 0x74, 0x6c, 0x65, 0x20,
	0x53, 0x54, 0x3d, 0x57, 0x61, 0x73, 0x68, 0x69,
	0x6e, 0x67, 0x74, 0x6f, 0x6e, 0x20, 0x43, 0x3d,
	0x55, 0x53, 0x30, 0x1e, 0x17, 0x0d, 0x31, 0x39,
	0x31, 0x32, 0x30, 0x34, 0x32, 0x33, 0x31, 0x39,
	0x31, 0x33, 0x5a, 0x17, 0x0d, 0x34, 0x39, 0x31,
	0x32, 0x33, 0x31, 0x32, 0x33, 0x35, 0x39, 0x35,
	0x39, 0x5a, 0x30, 0x1e, 0x31, 0x1c, 0x30, 0x1a,
	0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x13, 0x41,
	0x57, 0x53, 0x20, 0x49, 0x6f, 0x54, 0x20, 0x43,
	0x65, 0x72, 0x74, 0x69, 0x66, 0x69, 0x63, 0x61,
	0x74, 0x65, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0d,
	0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
	0x01, 0x01, 0x01, 0x05, 0x00, 0x03, 0x82, 0x01,
	0x0f, 0x00, 0x30, 0x82, 0x01, 0x0a, 0x02, 0x82,
	0x01, 0x01, 0x00, 0xe0, 0x96, 0xeb, 0x92, 0x93,
	0x05, 0x67, 0xac, 0xfc, 0xa7, 0x81, 0x9a, 0xb8,
	0x2b, 0x71, 0x63, 0xe8, 0xe3, 0xc5, 0xaf, 0xa7,
	0xbd, 0xd5, 0xf2, 0xf7, 0x14, 0x0e, 0xb5, 0xc4,
	0xbb, 0xcf, 0x09, 0x91, 0xe9, 0xa2, 0x97, 0x6c,
	0xb4, 0xd1, 0xa4, 0x89, 0x74, 0x40, 0xa1, 0xcf,
	0xbf, 0xc5, 0x3e, 0xce, 0x45, 0x01, 0x8d, 0xd3,
	0x89, 0x2a, 0xe0, 0x00, 0x9a, 0x63, 0x5a, 0xdf,
	0x11, 0x66, 0x98, 0x2a, 0xc7, 0xe2, 0x89, 0xeb,
	0x93, 0x37, 0x5e, 0x3a, 0x48, 0xe6, 0x55, 0x43,
	0xf9, 0x30, 0x4c, 0x07, 0xd5, 0x02, 0xcb, 0x4b,
	0x14, 0x00, 0x47, 0xdb, 0xdb, 0x4c, 0xf5, 0x71,
	0xfd, 0x74, 0x67, 0x73, 0x5b, 0xa1, 0x0e, 0xff,
	0x2b, 0x78, 0x1a, 0x31, 0x8b, 0x4b, 0xf5, 0xcc,
	0x14, 0x0e, 0xf2, 0x88, 0xc1, 0xd8, 0x4a, 0xea,
	0x08, 0x1b, 0xfa, 0x89, 0x4a, 0x6a, 0x27, 0xee,
	0x09, 0x5b, 0xcf, 0x90, 0x70, 0x82, 0xa7, 0xeb,
	0xd7, 0xb5, 0x38, 0xd6, 0x67, 0xc1, 0x3d, 0xec,
	0xd2, 0x8a, 0x23, 0xa7, 0x73, 0xe7, 0x3c, 0x6f,
	0x04, 0x2b, 0x3e, 0x4c, 0x83, 0x98, 0x70, 0xcb,
	0x38, 0xe1, 0x36, 0x56, 0x6c, 0x41, 0xb1, 0x7a,
	0xe2, 0xdc, 0xc7, 0x94, 0xf8, 0xce, 0x1d, 0x64,
	0xe2, 0xd4, 0x03, 0x9d, 0xce, 0x2e, 0x07, 0xf4,
	0xf2, 0xd9, 0xa6, 0x64, 0x91, 0xba, 0x51, 0xd7,
	0xed, 0xad, 0x4b, 0x61, 0x90, 0xf6, 0x20, 0x5a,
	0xa2, 0x69, 0xe6, 0xaf, 0x6e, 0xf6, 0xc2, 0x89,
	0x4c, 0x31, 0x45, 0x15, 0x6f, 0x17, 0xd9, 0x82,
	0x5f, 0xbd, 0xc9, 0x17, 0x97, 0xfd, 0x50, 0xbd,
	0xc3, 0x2b, 0x0f, 0x8e, 0xd2, 0xe5, 0x00, 0x62,
	0xe3, 0x30, 0x45, 0x28, 0x09, 0xfc, 0x44, 0xbb,
	0x5b, 0x9c, 0xdd, 0x92, 0x1b, 0x2f, 0x82, 0x38,
	0x66, 0x3f, 0x1b, 0x8d, 0x0c, 0xe7, 0x58, 0x5e,
	0xae, 0xbd, 0xcf, 0x02, 0x03, 0x01, 0x00, 0x01,
	0xa3, 0x60, 0x30, 0x5e, 0x30, 0x1f, 0x06, 0x03,
	0x55, 0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80,
	0x14, 0xe0, 0x76, 0xfe, 0x9e, 0x4b, 0x5c, 0xd6,
	0x4d, 0x00, 0x2d, 0xef, 0x08, 0xf6, 0x99, 0xb9,
	0xa3, 0xb7, 0x4d, 0x3c, 0x5a, 0x30, 0x1d, 0x06,
	0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14,
	0x07, 0xfa, 0x05, 0x6f, 0xa6, 0x58, 0x6f, 0x97,
	0x61, 0x8d, 0x9a, 0x81, 0xb1, 0x0c, 0x6b, 0xd6,
	0xff, 0x20, 0x3e, 0x56, 0x30, 0x0c, 0x06, 0x03,
	0x55, 0x1d, 0x13, 0x01, 0x01, 0xff, 0x04, 0x02,
	0x30, 0x00, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x1d,
	0x0f, 0x01, 0x01, 0xff, 0x04, 0x04, 0x03, 0x02,
	0x07, 0x80, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
	0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05,
	0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x6e, 0xb7,
	0xa1, 0x1e, 0xfc, 0xbe, 0x2f, 0x34, 0x2b, 0x7d,
	0x0a, 0x23, 0xac, 0x66, 0xd3, 0x73, 0x89, 0x24,
	0x5b, 0xb1, 0xc7, 0x44, 0x86, 0x70, 0x5c, 0x20,
	0xff, 0x9a, 0x8d, 0x12, 0xef, 0xa3, 0x74, 0xc7,
	0x79, 0xb1, 0xd7, 0xf8, 0x58, 0xe2, 0x96, 0x3e,
	0x96, 0x8d, 0x27, 0xe4, 0x7c, 0x63, 0x93, 0x89,
	0x44, 0x75, 0xfa, 0x91, 0x35, 0x6e, 0x8a, 0x5b,
	0x18, 0x7c, 0x43, 0x52, 0x0f, 0xa8, 0x2b, 0xf0,
	0x7f, 0x59, 0x98, 0xe9, 0x1f, 0x2c, 0x1e, 0x02,
	0x37, 0xb5, 0x89, 0xc3, 0x8c, 0xd2, 0x47, 0x26,
	0xca, 0xab, 0x73, 0x55, 0xa7, 0x33, 0xa3, 0xe0,
	0x7e, 0x00, 0x60, 0xf1, 0x99, 0xef, 0x80, 0xfb,
	0x96, 0x52, 0xa4, 0xf4, 0xf4, 0x73, 0x87, 0xab,
	0x7b, 0x69, 0xfc, 0xd4, 0x1a, 0x82, 0x22, 0xa3,
	0x44, 0xd9, 0x26, 0xc1, 0x77, 0xdb, 0x41, 0xbe,
	0x99, 0x09, 0x68, 0xe2, 0xf4, 0xae, 0x92, 0x56,
	0x00, 0x0f, 0xbc, 0x90, 0xd7, 0x2f, 0xe5, 0x4d,
	0x2f, 0xaf, 0xcc, 0xa6, 0x5c, 0x57, 0x1c, 0x1c,
	0x8f, 0x82, 0x1d, 0xcd, 0x5a, 0xde, 0x36, 0xe3,
	0x0e, 0x43, 0x31, 0xeb, 0x16, 0x11, 0xd8, 0xac,
	0x56, 0x7f, 0xf6, 0xb5, 0xce, 0xc6, 0x7a, 0x88,
	0x14, 0xfc, 0x12, 0x92, 0xfe, 0xfc, 0xc8, 0x7d,
	0xbe, 0x2f, 0x1a, 0x78, 0xec, 0x41, 0x86, 0xff,
	0xec, 0xb5, 0xd9, 0x41, 0xc5, 0x53, 0x31, 0x32,
	0xeb, 0x58, 0x63, 0x0e, 0x4a, 0xb8, 0xfb, 0x8c,
	0x56, 0x5e, 0x34, 0x87, 0x61, 0x60, 0x43, 0x68,
	0x79, 0x5d, 0xd9, 0x24, 0x0b, 0x33, 0xae, 0xa0,
	0x4a, 0xd5, 0xa7, 0x0a, 0x5c, 0x4c, 0x17, 0x10,
	0x98, 0x56, 0x39, 0xd0, 0x50, 0x4e, 0x56, 0x2a,
	0x60, 0x8e, 0x5d, 0x51, 0x90, 0xd1, 0x06, 0x78,
	0x37, 0x29, 0x88, 0x82, 0x0f, 0xfb, 0xb4, 0x87,
	0x4a, 0x98, 0xa8, 0x7d, 0xe4, 0x28,

};

static const uint8_t client_key_707f15c7fd_der[] = {
	0x30, 0x82, 0x04, 0xa2, 0x02, 0x01, 0x00, 0x02,
	0x82, 0x01, 0x01, 0x00, 0xe0, 0x96, 0xeb, 0x92,
	0x93, 0x05, 0x67, 0xac, 0xfc, 0xa7, 0x81, 0x9a,
	0xb8, 0x2b, 0x71, 0x63, 0xe8, 0xe3, 0xc5, 0xaf,
	0xa7, 0xbd, 0xd5, 0xf2, 0xf7, 0x14, 0x0e, 0xb5,
	0xc4, 0xbb, 0xcf, 0x09, 0x91, 0xe9, 0xa2, 0x97,
	0x6c, 0xb4, 0xd1, 0xa4, 0x89, 0x74, 0x40, 0xa1,
	0xcf, 0xbf, 0xc5, 0x3e, 0xce, 0x45, 0x01, 0x8d,
	0xd3, 0x89, 0x2a, 0xe0, 0x00, 0x9a, 0x63, 0x5a,
	0xdf, 0x11, 0x66, 0x98, 0x2a, 0xc7, 0xe2, 0x89,
	0xeb, 0x93, 0x37, 0x5e, 0x3a, 0x48, 0xe6, 0x55,
	0x43, 0xf9, 0x30, 0x4c, 0x07, 0xd5, 0x02, 0xcb,
	0x4b, 0x14, 0x00, 0x47, 0xdb, 0xdb, 0x4c, 0xf5,
	0x71, 0xfd, 0x74, 0x67, 0x73, 0x5b, 0xa1, 0x0e,
	0xff, 0x2b, 0x78, 0x1a, 0x31, 0x8b, 0x4b, 0xf5,
	0xcc, 0x14, 0x0e, 0xf2, 0x88, 0xc1, 0xd8, 0x4a,
	0xea, 0x08, 0x1b, 0xfa, 0x89, 0x4a, 0x6a, 0x27,
	0xee, 0x09, 0x5b, 0xcf, 0x90, 0x70, 0x82, 0xa7,
	0xeb, 0xd7, 0xb5, 0x38, 0xd6, 0x67, 0xc1, 0x3d,
	0xec, 0xd2, 0x8a, 0x23, 0xa7, 0x73, 0xe7, 0x3c,
	0x6f, 0x04, 0x2b, 0x3e, 0x4c, 0x83, 0x98, 0x70,
	0xcb, 0x38, 0xe1, 0x36, 0x56, 0x6c, 0x41, 0xb1,
	0x7a, 0xe2, 0xdc, 0xc7, 0x94, 0xf8, 0xce, 0x1d,
	0x64, 0xe2, 0xd4, 0x03, 0x9d, 0xce, 0x2e, 0x07,
	0xf4, 0xf2, 0xd9, 0xa6, 0x64, 0x91, 0xba, 0x51,
	0xd7, 0xed, 0xad, 0x4b, 0x61, 0x90, 0xf6, 0x20,
	0x5a, 0xa2, 0x69, 0xe6, 0xaf, 0x6e, 0xf6, 0xc2,
	0x89, 0x4c, 0x31, 0x45, 0x15, 0x6f, 0x17, 0xd9,
	0x82, 0x5f, 0xbd, 0xc9, 0x17, 0x97, 0xfd, 0x50,
	0xbd, 0xc3, 0x2b, 0x0f, 0x8e, 0xd2, 0xe5, 0x00,
	0x62, 0xe3, 0x30, 0x45, 0x28, 0x09, 0xfc, 0x44,
	0xbb, 0x5b, 0x9c, 0xdd, 0x92, 0x1b, 0x2f, 0x82,
	0x38, 0x66, 0x3f, 0x1b, 0x8d, 0x0c, 0xe7, 0x58,
	0x5e, 0xae, 0xbd, 0xcf, 0x02, 0x03, 0x01, 0x00,
	0x01, 0x02, 0x82, 0x01, 0x00, 0x1c, 0x57, 0x2f,
	0x16, 0xe9, 0xf2, 0x8e, 0xa8, 0xa7, 0xa1, 0x43,
	0x9b, 0x90, 0x8d, 0xfa, 0xdb, 0x0e, 0xb2, 0x5f,
	0x69, 0xd1, 0x13, 0x05, 0x82, 0x89, 0x67, 0x40,
	0x8b, 0xf3, 0x6d, 0x77, 0xac, 0xcf, 0x7a, 0xda,
	0x07, 0x9d, 0xb2, 0x1b, 0x9a, 0x55, 0xb6, 0x13,
	0xc9, 0xd7, 0x7b, 0x6d, 0x9a, 0x85, 0x50, 0xf3,
	0xe7, 0x3f, 0xc0, 0x59, 0x66, 0xb6, 0xec, 0xc4,
	0x88, 0xdd, 0x09, 0x47, 0x17, 0x00, 0x9f, 0x04,
	0x99, 0x3e, 0xde, 0xee, 0xe7, 0xb7, 0x17, 0x27,
	0xe9, 0xae, 0x90, 0x2d, 0x66, 0x0a, 0xbe, 0xf8,
	0x81, 0x4a, 0xd2, 0x15, 0x4e, 0xfc, 0x11, 0x6a,
	0x5e, 0xb6, 0xa9, 0xb3, 0x1c, 0xb2, 0xd3, 0xe7,
	0x39, 0x0b, 0x3e, 0x23, 0x03, 0xbb, 0x28, 0xc6,
	0xc7, 0x17, 0x9f, 0x98, 0x5b, 0x46, 0xa2, 0x9f,
	0x76, 0xa4, 0x9d, 0xad, 0x5a, 0x2a, 0x24, 0xf7,
	0xcc, 0x5e, 0x1f, 0x54, 0x34, 0x5a, 0x8e, 0x48,
	0x43, 0xeb, 0x03, 0x0d, 0x76, 0xd8, 0x79, 0x58,
	0x7d, 0x82, 0xe2, 0xcf, 0xfa, 0x26, 0x77, 0xf2,
	0x09, 0x4d, 0x61, 0x1d, 0xb8, 0xc2, 0xe6, 0xa7,
	0x49, 0xeb, 0x17, 0x0e, 0x21, 0xda, 0xe8, 0x3d,
	0x38, 0x75, 0x33, 0xed, 0x0f, 0xf0, 0x08, 0x51,
	0x0e, 0x26, 0x02, 0x96, 0x5e, 0x34, 0x61, 0x47,
	0x7a, 0xca, 0xa2, 0x27, 0x94, 0xea, 0x65, 0x5f,
	0x34, 0x6b, 0x93, 0x88, 0x10, 0xe7, 0x59, 0xce,
	0x73, 0x02, 0xb0, 0x01, 0x3b, 0xd4, 0xa6, 0x91,
	0xf3, 0xec, 0xca, 0xb5, 0xb0, 0x9d, 0x97, 0x23,
	0x1d, 0x1a, 0xb9, 0x12, 0x15, 0x34, 0x3e, 0xb2,
	0x95, 0x7e, 0x54, 0x4c, 0x7b, 0xc7, 0x3a, 0xba,
	0x02, 0x6e, 0x82, 0x1c, 0x1d, 0x82, 0x76, 0xae,
	0xd5, 0x6e, 0x80, 0xc5, 0x97, 0x02, 0xe1, 0xed,
	0x57, 0x02, 0x0e, 0x12, 0xa0, 0x33, 0x58, 0x3f,
	0x90, 0xa5, 0x25, 0x7b, 0x11, 0x02, 0x81, 0x81,
	0x00, 0xf6, 0x28, 0x7f, 0x1c, 0x36, 0x15, 0x41,
	0xb6, 0x49, 0x05, 0x6f, 0xa2, 0xd3, 0xf5, 0x1f,
	0xbb, 0x27, 0x05, 0xe9, 0x7a, 0x76, 0x16, 0x56,
	0xd5, 0xef, 0xaf, 0xcf, 0xa9, 0xf8, 0x9a, 0x7c,
	0x92, 0xd9, 0xfe, 0x2d, 0x24, 0x64, 0x46, 0xe0,
	0x46, 0x99, 0xcc, 0x39, 0xe8, 0xe1, 0x6f, 0xe0,
	0xde, 0x41, 0x7a, 0x57, 0xf3, 0x84, 0xbb, 0x34,
	0xa5, 0x47, 0x27, 0xd2, 0x4a, 0x44, 0x4a, 0x41,
	0xa7, 0x86, 0xde, 0x62, 0xb5, 0x6e, 0xc1, 0xfb,
	0x60, 0x73, 0x27, 0x15, 0xec, 0xc5, 0xca, 0xc0,
	0xa2, 0xaf, 0xd9, 0x4c, 0xf8, 0x14, 0x33, 0xc9,
	0xb8, 0x7d, 0x26, 0x81, 0xfc, 0xe5, 0x7c, 0xd1,
	0x1b, 0x42, 0xa9, 0x8f, 0x44, 0x49, 0x89, 0xc5,
	0x0d, 0x9d, 0xbf, 0x29, 0x70, 0x9e, 0xb9, 0xaa,
	0xcd, 0xa3, 0x15, 0xc0, 0xc5, 0x90, 0x09, 0x94,
	0xee, 0x57, 0x67, 0xf3, 0x4f, 0xf2, 0xd6, 0x06,
	0xeb, 0x02, 0x81, 0x81, 0x00, 0xe9, 0x91, 0xa9,
	0x75, 0xb1, 0x35, 0xc6, 0x98, 0xd7, 0x8c, 0x04,
	0x40, 0xc9, 0xfb, 0x1b, 0x22, 0x08, 0xa1, 0x3c,
	0xce, 0x4f, 0x87, 0x65, 0x48, 0x36, 0x36, 0x96,
	0x6c, 0xfa, 0x95, 0x31, 0x49, 0x5f, 0xc3, 0x34,
	0x0a, 0xc0, 0xe9, 0xcc, 0xb6, 0x8f, 0xd0, 0x3c,
	0x96, 0x5c, 0x6c, 0x30, 0x99, 0x3b, 0xe7, 0x00,
	0x7c, 0x81, 0xa5, 0x97, 0x49, 0xfb, 0xf9, 0x1e,
	0x25, 0x54, 0xdc, 0xd2, 0x95, 0x72, 0x7a, 0xec,
	0xaa, 0xd6, 0xfb, 0x3d, 0xce, 0x4d, 0x8a, 0x99,
	0x5f, 0xfc, 0xa1, 0x1f, 0x8d, 0x6e, 0x72, 0x2c,
	0x12, 0x97, 0xa5, 0x75, 0x73, 0x07, 0xe7, 0x75,
	0x21, 0x6b, 0xe0, 0x3c, 0x5b, 0xd2, 0x1e, 0xc5,
	0x92, 0x3b, 0x42, 0x6e, 0x43, 0x29, 0x55, 0x9e,
	0x23, 0xa0, 0x1f, 0xce, 0x88, 0x45, 0xea, 0x1f,
	0x86, 0x41, 0xce, 0x00, 0x78, 0xad, 0xec, 0x2f,
	0x21, 0x39, 0xb1, 0xf3, 0xad, 0x02, 0x81, 0x80,
	0x55, 0x1a, 0x97, 0x27, 0xa7, 0xc3, 0x1d, 0x9e,
	0xea, 0x0c, 0x09, 0x16, 0xa0, 0x75, 0x44, 0xed,
	0x2d, 0x86, 0xab, 0xbb, 0xfd, 0x0b, 0xa8, 0x25,
	0xfa, 0xe2, 0x2b, 0xc7, 0xb5, 0xfd, 0xa3, 0x48,
	0x1a, 0x39, 0xf8, 0x5d, 0x76, 0x95, 0xd2, 0x80,
	0x56, 0x37, 0xf7, 0x65, 0x7e, 0x5b, 0x71, 0xc1,
	0x25, 0x9e, 0x28, 0xbe, 0x36, 0x8b, 0x8a, 0x9e,
	0x01, 0xc5, 0xd0, 0xbc, 0x80, 0x73, 0xb3, 0xd3,
	0x39, 0x9b, 0xb5, 0x40, 0xc8, 0xf4, 0x23, 0xf6,
	0xaa, 0x99, 0x3e, 0xc9, 0x47, 0x70, 0xdb, 0xbc,
	0xe3, 0x53, 0x1b, 0x7b, 0x41, 0x70, 0xce, 0x33,
	0x0c, 0x81, 0xbd, 0xbb, 0x33, 0x94, 0x3d, 0xaf,
	0x51, 0x12, 0xd2, 0x47, 0x67, 0xad, 0x4c, 0x05,
	0x73, 0x1e, 0x5e, 0x33, 0x63, 0x8d, 0x09, 0x72,
	0x63, 0x09, 0xe8, 0x45, 0xe5, 0x90, 0x8a, 0x7f,
	0x04, 0x95, 0x19, 0xd7, 0xf0, 0x3a, 0xf2, 0xd5,
	0x02, 0x81, 0x80, 0x2e, 0x28, 0xf3, 0x6c, 0xa7,
	0x11, 0x11, 0xa6, 0xb3, 0x32, 0xa0, 0xc4, 0x8d,
	0x26, 0x6b, 0x3e, 0x56, 0xa6, 0x46, 0xf6, 0x1f,
	0x11, 0x8b, 0x1a, 0xb2, 0x5c, 0x27, 0x6e, 0x72,
	0x37, 0x79, 0xfe, 0x1e, 0x46, 0xdd, 0xca, 0x22,
	0x46, 0x12, 0x87, 0x21, 0xf4, 0xed, 0x84, 0x69,
	0xcf, 0x97, 0xeb, 0x30, 0xc3, 0x7e, 0x7d, 0x1c,
	0xc2, 0x35, 0x1c, 0x12, 0x08, 0x31, 0xc4, 0xfe,
	0xf8, 0x85, 0x45, 0xb3, 0xd2, 0x47, 0x63, 0x9c,
	0x09, 0x1b, 0x35, 0xe2, 0x6d, 0x39, 0xd2, 0x96,
	0x82, 0xe1, 0x51, 0x7a, 0x3a, 0x66, 0x2b, 0x66,
	0x7c, 0xf4, 0xb1, 0x3f, 0x26, 0xa7, 0x27, 0x6b,
	0xc2, 0x6d, 0x2b, 0x58, 0x63, 0x6c, 0x78, 0x71,
	0xed, 0xb7, 0x0c, 0xde, 0xe6, 0x64, 0xd2, 0x75,
	0x9a, 0xd3, 0x9e, 0x6a, 0xf2, 0xd2, 0x38, 0x1e,
	0x59, 0x30, 0x0e, 0xa9, 0x90, 0xbb, 0xdf, 0xbd,
	0x1f, 0x46, 0x21, 0x02, 0x81, 0x80, 0x6a, 0xb4,
	0x37, 0x2d, 0x0f, 0x90, 0x05, 0xe3, 0x75, 0x77,
	0xb1, 0xc8, 0x3f, 0xd9, 0x72, 0xe8, 0xc7, 0x6e,
	0x71, 0x07, 0xf3, 0xef, 0x67, 0xd2, 0xb2, 0xe0,
	0x64, 0x32, 0xc0, 0x12, 0xdf, 0xe4, 0x03, 0x97,
	0xbe, 0x21, 0xb5, 0xe4, 0x1d, 0x57, 0xea, 0x82,
	0x93, 0xe4, 0xf2, 0x94, 0xce, 0xec, 0xba, 0xb9,
	0xc5, 0x27, 0xde, 0x36, 0x24, 0x01, 0x82, 0xc3,
	0xef, 0x74, 0x92, 0x20, 0xad, 0xf8, 0x9f, 0x72,
	0x49, 0xfc, 0xc0, 0x4c, 0x5a, 0x22, 0xc6, 0xd4,
	0xb8, 0x69, 0x6a, 0x75, 0x9e, 0xc5, 0xb4, 0xdc,
	0xdc, 0xeb, 0xc6, 0xcc, 0xb1, 0x38, 0xcb, 0x58,
	0xbe, 0x41, 0xec, 0x30, 0xb2, 0xc1, 0x72, 0x38,
	0xfc, 0x05, 0xf4, 0x3e, 0xe9, 0xf4, 0x60, 0xb0,
	0xc7, 0xe5, 0x1a, 0x76, 0x6f, 0x95, 0x2d, 0xd2,
	0xae, 0x9a, 0x55, 0x13, 0xd9, 0x23, 0xf8, 0x72,
	0x28, 0xf5, 0x66, 0x2f, 0xa1, 0x2d,

};

typedef struct myss {
	struct lws_ss_handle	*ss;
	void			*opaque_data;
	/* ... application specific state ... */
	lws_sorted_usec_list_t	sul;

	size_t			size;

	int			count;
	uint8_t			done_eom:1;
	uint8_t			time_to_send_something:1;
} myss_t;

static unsigned long
fsize(FILE *fp)
{
	int sz;

	fseek(fp, 0L, SEEK_END);
	sz=ftell(fp);
	fseek(fp, 0,SEEK_SET); /* go back to where we were */

	lwsl_user("%s file size = %d\n", __func__, (int) sz);
	return (unsigned long) sz;
}

/* secure streams payload interface */

static int
myss_rx(void *userobj, const uint8_t *buf, size_t len, int flags)
{
	myss_t *m = (myss_t *)userobj;

	lwsl_user("%s: ssh: %p, len %d, flags: %d\n", __func__, m->ss, (int)len, flags);
	lwsl_hexdump_notice(buf, len);

	return 0;
}

static int
myss_tx(void *userobj, lws_ss_tx_ordinal_t ord, uint8_t *buf, size_t *len,
	int *flags)
{
	myss_t *m = (myss_t *)userobj;
	size_t os = m->size;

	*flags = 0;

	if (!m->size && !m->time_to_send_something)
		return 1;

	m->time_to_send_something = 0;

	if (just_once && !file_ptr && m->done_eom == 1) {
		interrupted = 1;
		bad = 0;
		return 1;
	}

	if (!m->size)
		*flags = LWSSS_FLAG_SOM;

	if (!file_ptr) {
		*len = lws_snprintf((char *)buf, *len, "{\"unixtime\":%lu}",
				(unsigned long)lws_now_secs());

		*flags |= LWSSS_FLAG_EOM;
		m->size = 0;
	} else {

		/* send from file mode */

		m->size += *len = fread(buf, 1, *len, file_ptr);
		if ((*len < 1) || feof(file_ptr)) {
			*flags |= LWSSS_FLAG_EOM;
			m->done_eom = 1;
			m->size = 0;
		} else
			lws_ss_request_tx(m->ss); /* ask to send more ASAP */
	}

	lwsl_notice("%s: h: %p, sending %u - %u flags 0x%x\n", __func__, m->ss,
		    (unsigned int)os, (unsigned int)(os + *len), *flags);

	return 0;

	/* don't want to send anything */

	//return 1;
}

static void
sul_cb(lws_sorted_usec_list_t *sul)
{
	myss_t *m = (myss_t *)lws_container_of(sul, myss_t, sul);

	m->time_to_send_something = 1;
	if (file_ptr)
		lws_ss_request_tx_len(m->ss, fsize(file_ptr));
	else
		lws_ss_request_tx(m->ss);

	lws_sul_schedule(lws_ss_get_context(m->ss), 0, &m->sul, sul_cb,
			 3 * LWS_USEC_PER_SEC);
}

static int
myss_state(void *userobj, void *sh, lws_ss_constate_t state,
	   lws_ss_tx_ordinal_t ack)
{
	myss_t *m = (myss_t *)userobj;

	lwsl_user("%s: %p: %s, ord 0x%x\n", __func__, m->ss,
		  lws_ss_state_name(state), (unsigned int)ack);

	switch (state) {
	case LWSSSCS_CREATING:
		if (file_ptr)
			lws_ss_request_tx_len(m->ss, fsize(file_ptr));
		else
			lws_ss_request_tx(m->ss);
		break;

	case LWSSSCS_CONNECTED:
		m->size = 0;
		lws_sul_schedule(lws_ss_get_context(m->ss), 0, &m->sul, sul_cb,
				  1 * LWS_USEC_PER_SEC);
		break;
	case LWSSSCS_DISCONNECTED:
	case LWSSSCS_DESTROYING:
		lws_sul_schedule(lws_ss_get_context(m->ss), 0, &m->sul, sul_cb,
				 LWS_SET_TIMER_USEC_CANCEL);
		break;

	case LWSSSCS_ALL_RETRIES_FAILED:
		/* if we're out of retries, we want to close the app and FAIL */
		interrupted = 1;
		break;
	default:
		break;
	}

	return 0;
}


static int
system_notify_cb(lws_state_manager_t *mgr, lws_state_notify_link_t *link,
		   int current, int target)
{
	struct lws_context *context = mgr->parent;
	lws_system_blob_t *ab = lws_system_get_blob(context,
				LWS_SYSBLOB_TYPE_AUTH, 1 /* AUTH_IDX_ROOT */);
	lws_ss_info_t ssi;
	size_t size;

	if (current == LWS_SYSTATE_REGISTERED ||
	    target == LWS_SYSTATE_REGISTERED) {

		size = lws_system_blob_get_size(ab);
		if (size)
			return 0;

		/* let's register our canned root token so auth can use it */
		lws_system_blob_direct_set(ab,
				(const uint8_t *)canned_root_token_payload,
				strlen(canned_root_token_payload));
		return 0;
	}

	if (current != LWS_SYSTATE_OPERATIONAL || target != LWS_SYSTATE_OPERATIONAL)
		return 0;

	lwsl_notice("%s: operational\n", __func__);

	memset(&ssi, 0, sizeof(ssi));
	ssi.handle_offset = offsetof(myss_t, ss);
	ssi.opaque_user_data_offset = offsetof(myss_t, opaque_data);
	ssi.rx = myss_rx;
	ssi.tx = myss_tx;
	ssi.state = myss_state;
	ssi.user_alloc = sizeof(myss_t);

	ssi.streamtype = "mqtt_test";

	if (lws_ss_create(context, 0, &ssi, NULL, NULL, NULL, NULL)) {
		lwsl_err("%s: failed to create secure stream\n",
			 __func__);
		interrupted = 1;
		return 0;
	}

	if (!file_ptr) {
		ssi.streamtype = "mqtt_test1";

		if (lws_ss_create(context, 0, &ssi, NULL, NULL, NULL, NULL)) {
			lwsl_err("%s: failed to create secure stream 2\n",
				 __func__);
			interrupted = 1;
			return 0;
		}
	}

	return 0;
}

static void
sigint_handler(int sig)
{
	interrupted = 1;
}

int main(int argc, const char **argv)
{
	lws_state_notify_link_t notifier = { {}, system_notify_cb, "app" };
	lws_state_notify_link_t *na[] = { &notifier, NULL };
	struct lws_context_creation_info info;
	struct lws_context *context;
	int n = 0;
	const char *p;

	if ((p = lws_cmdline_option(argc, argv, "--file"))) {
		file_ptr = fopen(p, "r");
		if (file_ptr == NULL) {
			lwsl_err("Error opening file \"%s\"\n", p);
			return 1;
		}

		lwsl_user("File opened %p\n", file_ptr);
	}

	if (lws_cmdline_option(argc, argv, "--once"))
		just_once = 1;

	signal(SIGINT, sigint_handler);

	memset(&info, 0, sizeof info); /* otherwise uninitialized garbage */
	lws_cmdline_option_handle_builtin(argc, argv, &info);
	lwsl_user("LWS secure streams [-d<verb>] [-f] [-p] [--h1post]\n");
	lwsl_user("   [--file <path-to-send>] [--once]\n");

	info.options = LWS_SERVER_OPTION_EXPLICIT_VHOSTS |
		       LWS_SERVER_OPTION_DO_SSL_GLOBAL_INIT;
	info.fd_limit_per_thread = 1 + 6 + 1;
	info.pss_policies_json = default_ss_policy;
	info.register_notifier_list = na;
	info.port = CONTEXT_PORT_NO_LISTEN;
#if defined(LWS_WITH_DETAILED_LATENCY)
	info.detailed_latency_cb = lws_det_lat_plot_cb;
	info.detailed_latency_filepath = "/tmp/lws-latency-ssproxy";
#endif

	context = lws_create_context(&info);
	if (!context) {
		lwsl_err("lws init failed\n");
		return 1;
	}

	/* set up our device's client cert and key */

	lws_system_blob_direct_set(lws_system_get_blob(context,
		LWS_SYSBLOB_TYPE_CLIENT_CERT_DER, 0), client_cert_707f15c7fd_der,
			sizeof(client_cert_707f15c7fd_der));

	lws_system_blob_direct_set(lws_system_get_blob(context,
		LWS_SYSBLOB_TYPE_CLIENT_KEY_DER, 0), client_key_707f15c7fd_der,
			sizeof(client_key_707f15c7fd_der));

	if (lws_cmdline_option(argc, argv, "-p"))
		is_proxy = 1;

	/* the event loop */

	while (n >= 0 && !interrupted)
		n = lws_service(context, 0);

	if (file_ptr)
		fclose(file_ptr);

	lws_context_destroy(context);
	lwsl_user("Completed: %s\n", bad ? "failed" : "OK");

	return bad;
}
